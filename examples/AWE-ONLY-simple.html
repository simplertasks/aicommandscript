<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>[[title]]</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
  <style>
    .test-button, .clear-button { margin-left: 0.5rem; }
  </style>
  <!-- AICS Metadata -->
  <script type="application/json" id="aics-metadata">
    {
      "title": "Fruit Quiz",
      "author": "J. Smith",
      "compatibility": "ChatGPT 4, 5"
    }
  </script>
</head>
<body>
  <section class="section">
    <div class="container">
      <h2 class="title is-2">[[title]]</h2>
      Author: [[author]]


  <!-- Hidden markdown content -->
  <textarea id="app-description" style="display: none;">


# Welcome to the Fruit Quiz!

This is a simple demonstration app that shows how to:

- Select from a list of fruits
- Describe your selection
- Get **interesting facts** from an AI

Try it out by selecting a fruit below!
</textarea>

  <!-- Rendered markdown will appear here -->
  <div id="rendered-description" class="content box"></div>

  <!-- API Key Input -->
  <div class="field">
    <label class="label">Groq API Key (Starts with 'gsk_')</label>
    <div class="control has-icons-right">
      <input class="input" type="text" id="api-key" placeholder="Enter your Groq API key (gsk_...)">
      <span class="icon is-small is-right">
        <button class="button test-button is-small" id="test-key">Test Key</button>
        <button class="button clear-button is-small" id="clear-key">Clear Key</button>
      </span>
    </div>
    <p class="help">Get your key at <a href="https://console.groq.com/keys">console.groq.com/keys</a></p>
  </div>

  <form id="fruitForm">
    <div class="field">
      <label class="label">Select a Fruit</label>
      <div class="control">
        <div class="select is-fullwidth">
          <select id="fruitSelect">
            <option value="">Choose a fruit...</option>
            <option value="Apple">Apple</option>
            <option value="Banana">Banana</option>
            <option value="Cherry">Cherry</option>
            <option value="Orange">Orange</option>
          </select>
        </div>
      </div>
    </div>

    <div class="field">
      <label class="label">List Four Things You Know About This Fruit</label>
      <div class="control">
        <textarea id="fruitDescription" class="textarea" placeholder="List four things you know about your selected fruit (one per line or separated by commas)..." rows="4"></textarea>
      </div>
    </div>

    <div class="field">
      <div class="control">
        <button type="submit" class="button is-primary">Submit</button>
      </div>
    </div>
  </form>

  <div class="field" style="margin-top: 2rem;">
    <label class="label">Result</label>
    <div class="control">
      <textarea id="resultArea" class="textarea" readonly rows="4" placeholder="Your selection will appear here..."></textarea>
    </div>
  </div>

  <div class="box" style="margin-top: 2rem;">
    <p id="outputText">You picked [[fruit]] and described it as [[description]].</p>
  </div>

  <div class="field" style="margin-top: 2rem;">
    <label class="label">API Request Prompt</label>
    <div class="control">
      <textarea id="apiPrompt" class="textarea" readonly rows="3" placeholder="The prompt sent to the API will appear here..."></textarea>
    </div>
  </div>
</div>

  </section>

  <!-- Load marked.js from CDN -->

  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

  <script>
    // Load and parse AICS metadata
    const metadataScript = document.getElementById('aics-metadata');
    const metadata = JSON.parse(metadataScript.textContent);

    // Replace all tokens throughout the entire HTML document
    function replaceAllTokens() {
      // Replace in document title
      let titleHTML = document.title;
      for (const [key, value] of Object.entries(metadata)) {
        const regex = new RegExp(`\\[\\[${key}\\]\\]`, 'g');
        titleHTML = titleHTML.replace(regex, value);
      }
      document.title = titleHTML;

      // Replace in body
      let bodyHTML = document.body.innerHTML;
      for (const [key, value] of Object.entries(metadata)) {
        const regex = new RegExp(`\\[\\[${key}\\]\\]`, 'g');
        bodyHTML = bodyHTML.replace(regex, value);
      }
      document.body.innerHTML = bodyHTML;
    }

    // Runtime manifest
    const manifest = {
      app_name: metadata.title,
      version: "2.1.1",
      provider: {
        model: "llama-3.1-8b-instant",
        api_endpoint: "https://api.groq.com/openai/v1/chat/completions"
      },
      debug: true
    };

    // Replace all tokens on page load
    replaceAllTokens();

    // Render markdown description (wait for marked.js to load)
    function renderMarkdown() {
      if (typeof marked === 'undefined') {
        console.error('marked.js not loaded yet');
        setTimeout(renderMarkdown, 100);
        return;
      }
      const markdownSource = document.getElementById('app-description').value;
      const renderedContainer = document.getElementById('rendered-description');
      renderedContainer.innerHTML = marked.parse(markdownSource);
    }
    renderMarkdown();

    // Load API key from localStorage (get element AFTER replaceAllTokens)
    const savedApiKey = localStorage.getItem('groqApiKey');
    if (savedApiKey) {
      document.getElementById('api-key').value = savedApiKey;
    }

    // Demo fact for offline mode
    function getDemoFact(fruit) {
      return {
        fun_fact: `Demo: ${fruit} is tasty!`,
        average_weight: "150",
        grade: "B",
        feedback: "Demo mode - no grading available without API key."
      };
    }

    // Groq API call for interesting fact
    async function getInterestingFact(fruit, userStatements, apiKey) {
      const prompt = `The user selected "${fruit}" and provided these statements about it:

${userStatements}

Please evaluate their knowledge and provide a response in JSON format with these fields:
- fun_fact: one interesting fact about ${fruit} (keep it concise)
- average_weight: typical weight in grams (just the number)
- grade: assign a single letter grade (A, B, C, D, or F) based on the overall accuracy and quality of their statements. Use your judgment.
- feedback: a brief explanation of why you gave that grade, mentioning what was correct or incorrect

Return only valid JSON, no other text.`;
      
      // Display the prompt in the API prompt textarea
      const apiPromptArea = document.getElementById('apiPrompt');
      apiPromptArea.value = prompt;
      
      if (!apiKey) return getDemoFact(fruit);
      if (!apiKey.startsWith('gsk_')) {
        throw new Error("Groq keys must start with 'gsk_'. Regenerate at console.groq.com/keys.");
      }
      try {
        const response = await fetch(manifest.provider.api_endpoint, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: manifest.provider.model,
            messages: [{ role: 'user', content: prompt }]
          })
        });
        const rawText = await response.text();
        if (manifest.debug) console.log('Raw Response:', rawText);
        if (!response.ok) {
          let errorMsg = `Groq API Error ${response.status}: ${response.statusText}`;
          try {
            const errorData = JSON.parse(rawText);
            errorMsg = errorData.error?.message || errorMsg;
          } catch {}
          throw new Error(errorMsg);
        }
        const data = JSON.parse(rawText);
        if (!data.choices?.[0]?.message?.content) {
          throw new Error(`Invalid response: Missing choices. Raw: ${rawText.substring(0, 200)}...`);
        }
        localStorage.setItem('groqApiKey', apiKey);
        
        // Parse the JSON response from the AI
        const content = data.choices[0].message.content;
        try {
          const fruitData = JSON.parse(content);
          return fruitData;
        } catch (parseError) {
          // If AI didn't return valid JSON, extract what we can
          if (manifest.debug) console.error('JSON Parse Error:', parseError, 'Content:', content);
          return {
            fun_fact: content,
            average_weight: "unknown",
            grade: "N/A",
            feedback: "Unable to parse AI response"
          };
        }
      } catch (error) {
        if (manifest.debug) console.error('API Error:', error);
        return {
          fun_fact: `Error: ${error.message}`,
          average_weight: "unknown",
          grade: "N/A",
          feedback: "Error occurred during grading"
        };
      }
    }

    // Form handler
    document.getElementById('fruitForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const fruit = document.getElementById('fruitSelect').value;
      const description = document.getElementById('fruitDescription').value;
      const apiKey = document.getElementById('api-key').value.trim();
      const resultArea = document.getElementById('resultArea');
      const outputText = document.getElementById('outputText');

      if (!fruit || !description) {
        resultArea.value = 'Please select a fruit and provide four statements about it.';
        outputText.textContent = 'You picked [[fruit]] and described it as [[description]].';
        return;
      }

      try {
        const fruitData = await getInterestingFact(fruit, description, apiKey);
        resultArea.value = `fruit: ${fruit.toLowerCase()}\nstatements: ${description}\ngrade: ${fruitData.grade}\nfeedback: ${fruitData.feedback}\nfun_fact: ${fruitData.fun_fact}\naverage_weight: ${fruitData.average_weight}g`;
        outputText.textContent = `You picked ${fruit.toLowerCase()}. Grade: ${fruitData.grade}. ${fruitData.feedback} ${fruitData.fun_fact} It typically weighs around ${fruitData.average_weight}g.`;
      } catch (error) {
        if (manifest.debug) console.error('Form Error:', error);
        resultArea.value = `fruit: ${fruit.toLowerCase()}\nstatements: ${description}\ngrade: N/A\nfeedback: Error: ${error.message}`;
        outputText.textContent = `You picked ${fruit.toLowerCase()}. Error: ${error.message}`;
      }
    });

    // Test Key Button
    document.getElementById('test-key').addEventListener('click', async () => {
      const apiKey = document.getElementById('api-key').value.trim();
      const outputText = document.getElementById('outputText');
      if (!apiKey) {
        outputText.textContent = 'Please enter an API key.';
        return;
      }
      outputText.textContent = 'Testing key...';
      try {
        const fruitData = await getInterestingFact('apple', 'Apples are red, grow on trees, are sweet, have seeds', apiKey);
        outputText.textContent = `Test OK! Grade: ${fruitData.grade}. ${fruitData.feedback}`;
      } catch (error) {
        outputText.textContent = `Test Failed: ${error.message}`;
      }
    });

    // Clear Key Button
    document.getElementById('clear-key').addEventListener('click', () => {
      localStorage.removeItem('groqApiKey');
      apiKeyInput.value = '';
      document.getElementById('outputText').textContent = 'API key cleared.';
    });
  </script>

</body>
</html>