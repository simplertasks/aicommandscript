<!DOCTYPE html>

<!-- 
  AI•Web Format v1.0
  A portable, single-file format for interactive AI experiences
-->

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="format" content="AI•Web v1.0">
  <title>${title}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
	
	<style>
  .chat-container { 
    max-height: 200px; 
    overflow-y: auto; 
    border: 1px solid #dbdbdb; 
    padding: 1rem; 
    margin-bottom: 1rem; 
  }
</style>
  <!-- AI•Web Metadata -->
  <script type="application/json" id="aiweb-metadata">
    {
      "format": "AI•Web",
      "version": "1.0",
      "title": "Fruit Quiz",
			"description": "Quiz app about edible fruits. AI grades user knowledge.",
      "author": "J. Smith",
      "compatibility": "ChatGPT 4, 5"
    }
  </script>
</head>
<body>
  <section class="section">
    <div class="container">
 


  <!-- Hidden markdown content -->
  <textarea id="app-description" style="display: none;">


# Welcome to the ${title}

> Author: ${author}

This is a simple demonstration app that shows how to:

- Select from a list of fruits
- Describe your selection
- Get **interesting facts** from an AI

Try it out by selecting a fruit below!
</textarea>


  <!-- Rendered markdown -->
  <div id="rendered-description" class="content box"></div>

  <!-- API Key Input -->
  <div class="field">
    <label class="label">Groq API Key (Starts with 'gsk_')</label>
    <div class="control has-icons-right">
      <input class="input" type="text" id="api-key" placeholder="Enter your Groq API key (gsk_...)">
      <span class="icon is-small is-right">
        <button class="button test-button is-small" id="test-key">Test Key</button>
        <button class="button clear-button is-small" id="clear-key">Clear Key</button>
      </span>
    </div>
    <p class="help">Get your key at <a href="https://console.groq.com/keys">console.groq.com/keys</a></p>
  </div>

  <form id="fruitForm">
    <div class="field">
      <label class="label">Select a Fruit</label>
      <div class="control">
        <div class="select is-fullwidth">
          <select id="fruitSelect">
            <option value="">Choose a fruit...</option>
            <option value="Apple">Apple</option>
            <option value="Banana">Banana</option>
            <option value="Cherry">Cherry</option>
            <option value="Orange">Orange</option>
          </select>
        </div>
      </div>
    </div>

    <div class="field">
      <label class="label">List Four Things You Know About This Fruit</label>
      <div class="control">
        <textarea id="fruitDescription" class="textarea" placeholder="List four things you know about your selected fruit (one per line or separated by commas)..." rows="4"></textarea>
      </div>
    </div>

    <div class="field">
      <div class="control">
        <button type="submit" class="button is-primary">Submit</button>
      </div>
    </div>
  </form>

  <div class="field" style="margin-top: 2rem;">
    <label class="label">Result</label>
    <div class="control">
      <textarea id="resultArea" class="textarea" readonly rows="4" placeholder="Your selection will appear here..."></textarea>
    </div>
  </div>

  <div class="box" style="margin-top: 2rem;">
    <p id="outputText">You picked ${fruit} and described it as ${description}.</p>
  </div>

  <div class="field" style="margin-top: 2rem;">
    <label class="label">API Request Prompt</label>
    <div class="control">
      <textarea id="apiPrompt" class="textarea" readonly rows="3" placeholder="The prompt sent to the API will appear here..."></textarea>
    </div>
  </div>

  <!-- Chat Feature -->
  <div class="field" style="margin-top: 2rem;">
    <label class="label">Chat with AI</label>
    <div class="chat-container" id="chatHistory"></div>
    <div class="control">
      <input class="input" type="text" id="chatInput" placeholder="Ask about fruits or anything else...">
    </div>
    <div class="control" style="margin-top: 0.5rem;">
      <button class="button is-primary" id="sendChat">Send</button>
    </div>
  </div>

  <!-- Study Guide Feature -->
  <div class="field" style="margin-top: 2rem;">
    <label class="label">Study Guide</label>
    <div class="control">
      <button class="button is-primary" id="studyGuide">Generate Study Guide</button>
    </div>
    <div class="field" style="margin-top: 1rem;">
      <label class="label">Study Guide Output</label>
      <div class="control">
        <textarea id="studyGuideOutput" class="textarea" readonly rows="10" placeholder="The study guide will appear here..."></textarea>
      </div>
    </div>
  </div>
</div>


  </section>

  <!-- Load marked.js from CDN -->

  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

  <script>
    // Load and parse AI•Web metadata
    const metadataScript = document.getElementById('aiweb-metadata');
    const metadata = JSON.parse(metadataScript.textContent);

    // Replace all tokens throughout the entire HTML document
    function replaceAllTokens() {
      // Replace in document title
      let titleHTML = document.title;
      titleHTML = titleHTML.replace(/\$\{(\w+)\}/g, (match, key) => {
        return metadata[key] || match;
      });
      document.title = titleHTML;

      // Replace in body
      let bodyHTML = document.body.innerHTML;
      bodyHTML = bodyHTML.replace(/\$\{(\w+)\}/g, (match, key) => {
        return metadata[key] || match;
      });
      document.body.innerHTML = bodyHTML;
    }

    // Runtime manifest
    const manifest = {
      format: metadata.format,
      format_version: metadata.version,
      app_name: metadata.title,
      version: "2.3.0",
      provider: {
        model: "llama-3.1-8b-instant",
        api_endpoint: "https://api.groq.com/openai/v1/chat/completions"
      },
      fruits: ["Apple", "Banana", "Cherry", "Orange"],
      debug: true
    };

    // Replace all tokens on page load
    replaceAllTokens();

    // Render markdown description (wait for marked.js to load)
    function renderMarkdown() {
      if (typeof marked === 'undefined') {
        console.error('marked.js not loaded yet');
        setTimeout(renderMarkdown, 100);
        return;
      }
      const markdownSource = document.getElementById('app-description').value;
      const renderedContainer = document.getElementById('rendered-description');
      renderedContainer.innerHTML = marked.parse(markdownSource);
    }
    renderMarkdown();

    // Load API key from localStorage (get element AFTER replaceAllTokens)
    const savedApiKey = localStorage.getItem('groqApiKey');
    if (savedApiKey) {
      document.getElementById('api-key').value = savedApiKey;
    }

    // Demo fact for offline mode
    function getDemoFact(fruit) {
      return {
        fun_fact: `Demo: ${fruit} is tasty!`,
        average_weight: "150",
        grade: "B",
        feedback: "Demo mode - no grading available without API key."
      };
    }

    // Demo chat response for offline mode
    function getDemoChatResponse(message) {
      return `Demo: That's an interesting question about ${message}! Try using an API key for a real response.`;
    }

    // Demo study guide for offline mode
    function getDemoStudyGuide() {
      return `| Fruit | Fact 1 | Fact 2 | Fact 3 | Fact 4 | Fact 5 | Fact 6 |\n|-------|--------|--------|--------|--------|--------|--------|\n${manifest.fruits.map(fruit => `| ${fruit} | Demo: ${fruit} is tasty! | Demo: It's colorful! | Demo: It's sweet! | Demo: It's juicy! | Demo: It's healthy! | Demo: It's fun! |`).join('\n')}`;
    }

    // Groq API call for interesting fact
    async function getInterestingFact(fruit, userStatements, apiKey) {
     
	const prompt = `${metadata.description}

    The user selected "${fruit}" and provided these statements about it:

${userStatements}

Please evaluate their knowledge and provide a response in JSON format with these fields:
- fun_fact: one interesting fact about ${fruit} (keep it concise)
- average_weight: typical weight in grams (just the number)
- grade: assign a single letter grade (A, B, C, D, or F) based on the overall accuracy and quality of their statements. Use your judgment.
- feedback: a brief explanation of why you gave that grade, mentioning what was correct or incorrect

Return only valid JSON, no other text.`;

      // Display the prompt in the API prompt textarea
      const apiPromptArea = document.getElementById('apiPrompt');
      apiPromptArea.value = prompt;

      if (!apiKey) return getDemoFact(fruit);
      if (!apiKey.startsWith('gsk_')) {
        throw new Error("Groq keys must start with 'gsk_'. Regenerate at console.groq.com/keys.");
      }
      try {
        const response = await fetch(manifest.provider.api_endpoint, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: manifest.provider.model,
            messages: [{ role: 'user', content: prompt }]
          })
        });
        const rawText = await response.text();
        if (manifest.debug) console.log('Raw Response:', rawText);
        if (!response.ok) {
          let errorMsg = `Groq API Error ${response.status}: ${response.statusText}`;
          try {
            const errorData = JSON.parse(rawText);
            errorMsg = errorData.error?.message || errorMsg;
          } catch {}
          throw new Error(errorMsg);
        }
        const data = JSON.parse(rawText);
        if (!data.choices?.[0]?.message?.content) {
          throw new Error(`Invalid response: Missing choices. Raw: ${rawText.substring(0, 200)}...`);
        }
        localStorage.setItem('groqApiKey', apiKey);

        // Parse the JSON response from the AI
        const content = data.choices[0].message.content;
        try {
          const fruitData = JSON.parse(content);
          return fruitData;
        } catch (parseError) {
          if (manifest.debug) console.error('JSON Parse Error:', parseError, 'Content:', content);
          return {
            fun_fact: content,
            average_weight: "unknown",
            grade: "N/A",
            feedback: "Unable to parse AI response"
          };
        }
      } catch (error) {
        if (manifest.debug) console.error('API Error:', error);
        return {
          fun_fact: `Error: ${error.message}`,
          average_weight: "unknown",
          grade: "N/A",
          feedback: "Error occurred during grading"
        };
      }
    }

    // Groq API call for chat
    async function getChatResponse(message, apiKey) {
      if (!apiKey) return getDemoChatResponse(message);
      if (!apiKey.startsWith('gsk_')) {
        throw new Error("Groq keys must start with 'gsk_'. Regenerate at console.groq.com/keys.");
      }
      try {
        const response = await fetch(manifest.provider.api_endpoint, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: manifest.provider.model,
            messages: [{ role: 'user', content: `Answer in a friendly, concise manner with emojis: ${message}` }]
          })
        });
        const rawText = await response.text();
        if (manifest.debug) console.log('Chat Raw Response:', rawText);
        if (!response.ok) {
          let errorMsg = `Groq API Error ${response.status}: ${response.statusText}`;
          try {
            const errorData = JSON.parse(rawText);
            errorMsg = errorData.error?.message || errorMsg;
          } catch {}
          throw new Error(errorMsg);
        }
        const data = JSON.parse(rawText);
        if (!data.choices?.[0]?.message?.content) {
          throw new Error(`Invalid response: Missing choices. Raw: ${rawText.substring(0, 200)}...`);
        }
        return data.choices[0].message.content;
      } catch (error) {
        if (manifest.debug) console.error('Chat API Error:', error);
        return `Error: ${error.message}. Try again!`;
      }
    }

    // Groq API call for study guide
    async function getStudyGuide(apiKey) {
			
			const prompt = `${metadata.description}\n\nGenerate a Markdown table listing six interesting facts for each of the following fruits: Apple, Banana, Cherry, Orange. Use this format:
| Fruit | Fact 1 | Fact 2 | Fact 3 | Fact 4 | Fact 5 | Fact 6 |
|-------|--------|--------|--------|--------|--------|--------|
Each fact should be concise (1-2 sentences), unique, and include emojis. Return only the Markdown table, no other text.`;

      if (!apiKey) return getDemoStudyGuide();
      if (!apiKey.startsWith('gsk_')) {
        throw new Error("Groq keys must start with 'gsk_'. Regenerate at console.groq.com/keys.");
      }
      try {
        const response = await fetch(manifest.provider.api_endpoint, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: manifest.provider.model,
            messages: [{ role: 'user', content: prompt }]
          })
        });
        const rawText = await response.text();
        if (manifest.debug) console.log('Study Guide Raw Response:', rawText);
        if (!response.ok) {
          let errorMsg = `Groq API Error ${response.status}: ${response.statusText}`;
          try {
            const errorData = JSON.parse(rawText);
            errorMsg = errorData.error?.message || errorMsg;
          } catch {}
          throw new Error(errorMsg);
        }
        const data = JSON.parse(rawText);
        if (!data.choices?.[0]?.message?.content) {
          throw new Error(`Invalid response: Missing choices. Raw: ${rawText.substring(0, 200)}...`);
        }
        return data.choices[0].message.content;
      } catch (error) {
        if (manifest.debug) console.error('Study Guide API Error:', error);
        return `Error: ${error.message}\n\n${getDemoStudyGuide()}`;
      }
    }

    // Form handler
    document.getElementById('fruitForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const fruit = document.getElementById('fruitSelect').value;
      const description = document.getElementById('fruitDescription').value;
      const apiKey = document.getElementById('api-key').value.trim();
      const resultArea = document.getElementById('resultArea');
      const outputText = document.getElementById('outputText');

      if (!fruit || !description) {
        resultArea.value = 'Please select a fruit and provide four statements about it.';
        outputText.textContent = 'You picked ${fruit} and described it as ${description}.';
        return;
      }

      try {
        const fruitData = await getInterestingFact(fruit, description, apiKey);
        resultArea.value = `fruit: ${fruit.toLowerCase()}\nstatements: ${description}\ngrade: ${fruitData.grade}\nfeedback: ${fruitData.feedback}\nfun_fact: ${fruitData.fun_fact}\naverage_weight: ${fruitData.average_weight}g`;
        outputText.textContent = `You picked ${fruit.toLowerCase()}. Grade: ${fruitData.grade}. ${fruitData.feedback} ${fruitData.fun_fact} It typically weighs around ${fruitData.average_weight}g.`;
      } catch (error) {
        if (manifest.debug) console.error('Form Error:', error);
        resultArea.value = `fruit: ${fruit.toLowerCase()}\nstatements: ${description}\ngrade: N/A\nfeedback: Error: ${error.message}`;
        outputText.textContent = `You picked ${fruit.toLowerCase()}. Error: ${error.message}`;
      }
    });

    // Test Key Button
    document.getElementById('test-key').addEventListener('click', async () => {
      const apiKey = document.getElementById('api-key').value.trim();
      const outputText = document.getElementById('outputText');
      if (!apiKey) {
        outputText.textContent = 'Please enter an API key.';
        return;
      }
      outputText.textContent = 'Testing key...';
      try {
        const fruitData = await getInterestingFact('apple', 'Apples are red, grow on trees, are sweet, have seeds', apiKey);
        outputText.textContent = `Test OK! Grade: ${fruitData.grade}. ${fruitData.feedback}`;
      } catch (error) {
        outputText.textContent = `Test Failed: ${error.message}`;
      }
    });

    // Clear Key Button
    document.getElementById('clear-key').addEventListener('click', () => {
      localStorage.removeItem('groqApiKey');
      document.getElementById('api-key').value = '';
      document.getElementById('outputText').textContent = 'API key cleared.';
    });

    // Chat handler
    document.getElementById('sendChat').addEventListener('click', async () => {
      const chatInput = document.getElementById('chatInput');
      const message = chatInput.value.trim();
      const chatHistory = document.getElementById('chatHistory');
      const apiKey = document.getElementById('api-key').value.trim();

      if (!message) {
        chatHistory.innerHTML += `<div class="chat-message chat-user">You: Please type a message.</div>`;
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return;
      }

      // Add user message to history
      chatHistory.innerHTML += `<div class="chat-message chat-user">You: ${message}</div>`;
      chatInput.value = '';

      // Get AI response
      const response = await getChatResponse(message, apiKey);
      chatHistory.innerHTML += `<div class="chat-message chat-ai">AI: ${response}</div>`;
      chatHistory.scrollTop = chatHistory.scrollHeight;
    });

    // Allow Enter key to send chat
    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('sendChat').click();
      }
    });

    // Study Guide handler
    document.getElementById('studyGuide').addEventListener('click', async () => {
      const apiKey = document.getElementById('api-key').value.trim();
      const studyGuideOutput = document.getElementById('studyGuideOutput');
      studyGuideOutput.value = 'Generating study guide...';
      try {
        const studyGuide = await getStudyGuide(apiKey);
        studyGuideOutput.value = studyGuide;
      } catch (error) {
        studyGuideOutput.value = `Error: ${error.message}\n\n${getDemoStudyGuide()}`;
      }
    });
  </script>

</body>
</html>